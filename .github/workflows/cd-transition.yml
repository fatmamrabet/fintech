name: CD Transition (The Deployer)

on:
  push:
    branches:
      - develop
      - main

  # Pour tester à la main depuis l'onglet Actions
  workflow_dispatch:
    inputs:
      issue_key:
        description: "Jira key (ex: FNC-4)"
        required: true
        default: "FNC-4"
      simulate_target:
        description: "develop | main | hotfix"
        required: true
        default: "develop"

jobs:
  cd:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to Jira
        uses: atlassian/gajira-login@v3
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

      # 1) Decide ISSUE + "mode" (push vs manual)
      - name: Decide issue + mode + target
        id: decide
        shell: bash
        run: |
          set -e

          EVENT="${{ github.event_name }}"
          BRANCH="${{ github.ref_name }}"

          # --- Manual run (workflow_dispatch) ---
          if [ "$EVENT" = "workflow_dispatch" ]; then
            echo "issue=${{ inputs.issue_key }}" >> "$GITHUB_OUTPUT"
            echo "branch_sim=${{ inputs.simulate_target }}" >> "$GITHUB_OUTPUT"
            echo "mode=manual" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # --- Push run (after merge/push to develop/main) ---
          MSG="${{ github.event.head_commit.message }}"
          echo "Commit message: $MSG"

          ISSUE=$(echo "$MSG" | grep -oE 'FNC-[0-9]+' | head -n 1)
          if [ -z "$ISSUE" ]; then
            echo "❌ No Jira key found in merge commit message."
            echo "✅ Fix: ensure PR title contains FNC-xx before merging."
            exit 1
          fi

          echo "issue=$ISSUE" >> "$GITHUB_OUTPUT"
          echo "branch_sim=$BRANCH" >> "$GITHUB_OUTPUT"
          echo "mode=push" >> "$GITHUB_OUTPUT"

      # 2) Apply the correct Jira transitions
      #    develop -> Done (In Dev)
      #    main release -> Released (if not possible: Done then Released)
      #    main hotfix -> Hotfix Deployed
      - name: Apply Jira transitions (smart)
        id: apply
        shell: bash
        run: |
          set -e

          ISSUE="${{ steps.decide.outputs.issue }}"
          TARGET="${{ steps.decide.outputs.branch_sim }}"
          echo "Issue: $ISSUE"
          echo "Target (branch or simulation): $TARGET"

          # Helpers: find transition id by matching "to.name" contains token (case-insensitive)
          get_transition_id () {
            local token="$1"
            local json
            json=$(curl -sS -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
              -H "Accept: application/json" \
              "${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue/${ISSUE}/transitions")

            # Print available transitions (useful for debug)
            echo "Available transitions:"
            echo "$json" | jq -r '.transitions[] | " - id=" + .id + " | name=" + .name + " | to=" + .to.name' || true

            # Return first matching id
            echo "$json" | jq -r --arg t "$token" '
              .transitions[]
              | select( ((.to.name // "" | ascii_downcase) | contains($t | ascii_downcase))
                     or ((.name   // "" | ascii_downcase) | contains($t | ascii_downcase)) )
              | .id
            ' | head -n 1
          }

          do_transition () {
            local id="$1"
            echo "➡️ Applying transition id=$id"
            curl -sS -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
              -H "Accept: application/json" \
              -H "Content-Type: application/json" \
              -X POST \
              --data "{\"transition\":{\"id\":\"$id\"}}" \
              "${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue/${ISSUE}/transitions" >/dev/null
          }

          # Decide scenario
          if [ "$TARGET" = "develop" ]; then
            # Done (In Dev) in your Jira is "Terminé(e)" / "Terminée(e)" -> we match token "termin"
            ID_DONE=$(get_transition_id "termin")
            if [ -z "$ID_DONE" ] || [ "$ID_DONE" = "null" ]; then
              echo "❌ No transition found for Done (token=termin)"
              exit 1
            fi
            do_transition "$ID_DONE"
            echo "✅ Moved to Done (In Dev)"
            exit 0
          fi

          # main path (release or hotfix)
          # If commit message mentions hotfix -> hotfix deployed
          MSG="${{ github.event.head_commit.message }}"
          if [ "${{ steps.decide.outputs.mode }}" = "manual" ] && [ "$TARGET" = "hotfix" ]; then
            IS_HOTFIX="yes"
          elif echo "$MSG" | grep -qiE 'hotfix/|hotfix'; then
            IS_HOTFIX="yes"
          else
            IS_HOTFIX="no"
          fi

          if [ "$IS_HOTFIX" = "yes" ]; then
            ID_HOTFIX=$(get_transition_id "hotfix")
            if [ -z "$ID_HOTFIX" ] || [ "$ID_HOTFIX" = "null" ]; then
              echo "❌ No transition found for Hotfix Deployed (token=hotfix)"
              exit 1
            fi
            do_transition "$ID_HOTFIX"
            echo "✅ Moved to Hotfix Deployed"
            exit 0
          fi

          # Standard release -> Released
          ID_REL=$(get_transition_id "released")
          if [ -n "$ID_REL" ] && [ "$ID_REL" != "null" ]; then
            do_transition "$ID_REL"
            echo "✅ Moved to Released"
            exit 0
          fi

          # If Released is not available, do Done then Released
          echo "⚠️ Released not available from current status. Doing Done -> Released."

          ID_DONE=$(get_transition_id "termin")
          if [ -z "$ID_DONE" ] || [ "$ID_DONE" = "null" ]; then
            echo "❌ Can't even move to Done (token=termin)."
            exit 1
          fi
          do_transition "$ID_DONE"

          ID_REL2=$(get_transition_id "released")
          if [ -z "$ID_REL2" ] || [ "$ID_REL2" = "null" ]; then
            echo "❌ Still no Released after moving to Done."
            exit 1
          fi
          do_transition "$ID_REL2"
          echo "✅ Moved to Released (after Done)"

      - name: Deploy
        run: echo "Deploying artifact..."
