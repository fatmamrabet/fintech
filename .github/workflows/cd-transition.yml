name: CD Transition (The Deployer)

on:
  push:
    branches:
      - develop
      - main

jobs:
  cd:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # (Optionnel mais recommandé) -> si tu veux éviter des surprises
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Login to Jira
        uses: atlassian/gajira-login@v3
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

      - name: Extract Jira key from commit message
        id: jira
        shell: bash
        run: |
          MSG="${{ github.event.head_commit.message }}"
          echo "Commit message: $MSG"

          ISSUE=$(echo "$MSG" | grep -oE 'FNC-[0-9]+' | head -n 1)

          if [ -z "$ISSUE" ]; then
            echo "No Jira key found in commit message"
            exit 1
          fi

          echo "issue=$ISSUE" >> "$GITHUB_OUTPUT"

      - name: Move ticket based on target branch
        shell: bash
        run: |
          set -e
          ISSUE="${{ steps.jira.outputs.issue }}"
          BRANCH="${{ github.ref_name }}"
          MSG="${{ github.event.head_commit.message }}"

          echo "Issue: $ISSUE"
          echo "Branch: $BRANCH"
          echo "Commit message (raw):"
          echo "$MSG"

          TRANSITIONS=$(curl -sS -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            -H "Accept: application/json" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue/${ISSUE}/transitions")

          echo "Available transitions:"
          echo "$TRANSITIONS" | jq -r '.transitions[] | " - " + .id + " -> " + .to.name' || true

          find_id () {
            local token="$1"
            echo "$TRANSITIONS" | jq -r --arg t "$token" '
              .transitions[]
              | select(((.to.name // "") | ascii_downcase) | contains(($t | ascii_downcase)))
              | .id
            ' | head -n 1
          }

          do_transition () {
            local id="$1"
            curl -sS -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
              -H "Content-Type: application/json" \
              -X POST \
              --data "{\"transition\":{\"id\":\"$id\"}}" \
              "${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue/${ISSUE}/transitions" >/dev/null
          }

          # CHOIX DE SCENARIO (robuste)
          if [ "$BRANCH" = "develop" ]; then
            # Done (In Dev)
            ID_DONE="$(find_id "termin")"
            if [ -z "$ID_DONE" ] || [ "$ID_DONE" = "null" ]; then
              echo "Nothing to do: no 'Terminé' transition available."
              exit 0
            fi
            echo "Target: Terminé (develop)"
            do_transition "$ID_DONE"
            echo "moved to Terminé"
            exit 0
          fi

          # BRANCH = main :
          ID_HOTFIX="$(find_id "hotfix")"
          if [ -n "$ID_HOTFIX" ] && [ "$ID_HOTFIX" != "null" ]; then
            echo "Target: Hotfix Deployed (main)"
            do_transition "$ID_HOTFIX"
            echo "moved to Hotfix Deployed"
            exit 0
          fi

          ID_REL="$(find_id "released")"
          if [ -n "$ID_REL" ] && [ "$ID_REL" != "null" ]; then
            echo "Target: Released (main)"
            do_transition "$ID_REL"
            echo "moved to Released"
            exit 0
          fi

          echo "Nothing to do: no Hotfix Deployed / Released transition available."
          exit 0

      # Déploiement Azure (remplace l'echo)
      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: fintech-fatma-2026-payments
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: .

      # Check rapide après déploiement (preuve)
      - name: Smoke test /health
        shell: bash
        run: |
          set -e
          URL="https://fintech-fatma-2026-payments.azurewebsites.net/health"
          echo "Checking $URL"
          curl -sS "$URL"
