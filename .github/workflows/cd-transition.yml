name: CD Transition (The Deployer)

on:
  push:
    branches:
      - develop
      - main

  workflow_dispatch:
    inputs:
      issue:
        description: "Jira issue key (ex: FNC-4). Laisse vide pour auto-detect depuis le commit."
        required: false
        default: ""
      simulate_branch:
        description: "Pour tester: force la branche cible (develop ou main). Laisse vide pour utiliser la vraie branche."
        required: false
        default: ""

jobs:
  cd:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to Jira
        uses: atlassian/gajira-login@v3
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

      # 1) D√©terminer la cl√© Jira
      - name: Determine Jira issue key
        id: jirakey
        shell: bash
        run: |
          set -euo pipefail

          INPUT_ISSUE="${{ github.event.inputs.issue }}"
          if [ -n "$INPUT_ISSUE" ]; then
            ISSUE="$INPUT_ISSUE"
          else
            MSG="${{ github.event.head_commit.message }}"
            echo "Commit message: $MSG"
            ISSUE=$(echo "$MSG" | grep -oE 'FNC-[0-9]+' | head -n 1 || true)
            if [ -z "$ISSUE" ]; then
              echo "‚ùå No Jira key found in commit message."
              echo "üëâ Lance le workflow manuellement (workflow_dispatch) et mets issue=FNC-4."
              exit 1
            fi
          fi

          echo "‚úÖ Issue: $ISSUE"
          echo "issue=$ISSUE" >> "$GITHUB_OUTPUT"

      # 2) D√©cider le statut cible
      - name: Decide target status
        id: decide
        shell: bash
        run: |
          set -euo pipefail

          SIM_BRANCH="${{ github.event.inputs.simulate_branch }}"
          if [ -n "$SIM_BRANCH" ]; then
            BRANCH="$SIM_BRANCH"
          else
            BRANCH="${{ github.ref_name }}"
          fi

          MSG="${{ github.event.head_commit.message }}"
          echo "Branch considered: $BRANCH"
          echo "Commit message: $MSG"

          if [ "$BRANCH" = "develop" ]; then
            # Chez toi c‚Äôest souvent "Termin√©e(e)" (Done In Dev).
            # Si √ßa ne match pas, on ajustera apr√®s le debug transitions.
            echo "target=Termin√©e(e)" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # BRANCH = main
          if echo "$MSG" | grep -qiE 'hotfix/|hotfix'; then
            echo "target=Hotfix Deployed" >> "$GITHUB_OUTPUT"
          else
            echo "target=Released" >> "$GITHUB_OUTPUT"
          fi

      # 3) Afficher les transitions disponibles (pour comprendre)
      - name: Debug available transitions
        shell: bash
        run: |
          set -euo pipefail
          ISSUE="${{ steps.jirakey.outputs.issue }}"
          echo "=== Available transitions for $ISSUE ==="
          curl -sS -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            -H "Accept: application/json" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue/${ISSUE}/transitions" | jq .
          echo ""

      # 4) Trouver l'ID de transition via jq (pas de Python)
      - name: Resolve transition id
        id: resolve
        shell: bash
        run: |
          set -euo pipefail

          ISSUE="${{ steps.jirakey.outputs.issue }}"
          TARGET="${{ steps.decide.outputs.target }}"
          TARGET_LC="$(echo "$TARGET" | tr '[:upper:]' '[:lower:]')"

          json=$(curl -sS -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            -H "Accept: application/json" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue/${ISSUE}/transitions")

          TRANS_ID=$(echo "$json" | jq -r --arg t "$TARGET_LC" '
            .transitions[]
            | select(((.name // "") | ascii_downcase | contains($t)) or (((.to.name // "") | ascii_downcase | contains($t))))
            | .id
          ' | head -n 1)

          if [ -z "$TRANS_ID" ] || [ "$TRANS_ID" = "null" ]; then
            echo "‚ùå No matching transition found for target='$TARGET'."
            echo "üëâ Donc depuis le statut ACTUEL du ticket, Jira ne propose pas une transition vers '$TARGET'."
            echo "üëâ Mets le ticket dans le bon statut (ex: Ready for Review avant Done), puis relance."
            exit 1
          fi

          echo "‚úÖ Transition id: $TRANS_ID"
          echo "id=$TRANS_ID" >> "$GITHUB_OUTPUT"

      # 5) Appliquer la transition
      - name: Move Jira ticket
        uses: atlassian/gajira-transition@v3
        with:
          issue: ${{ steps.jirakey.outputs.issue }}
          transition: ${{ steps.resolve.outputs.id }}

      # 6) Simulation de d√©ploiement
      - name: Deploy
        run: echo "Deploying artifact..."
