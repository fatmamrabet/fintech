name: CD Transition (The Deployer)

on:
  push:
    branches:
      - develop
      - main

  # Permet de lancer manuellement depuis l'UI GitHub ("Run workflow")
  workflow_dispatch:
    inputs:
      issue:
        description: "Jira issue key (ex: FNC-4)"
        required: true
      mode:
        description: "develop | main | hotfix (choix manuel si tu testes)"
        required: true
        default: "develop"

jobs:
  cd:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to Jira
        uses: atlassian/gajira-login@v3
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

      # 1) Déterminer la clé Jira
      # - en "push": on essaye de la trouver dans le message du commit (merge commit)
      # - en "workflow_dispatch": tu la donnes toi-même
      - name: Resolve Jira issue key
        id: issue
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ISSUE="${{ inputs.issue }}"
          else
            MSG="${{ github.event.head_commit.message }}"
            echo "Head commit message: $MSG"
            ISSUE=$(echo "$MSG" | grep -oE 'FNC-[0-9]+' | head -n 1)
          fi

          if [ -z "$ISSUE" ]; then
            echo "❌ No Jira key found."
            echo "➡️ Solution: make sure your merge commit / PR title contains FNC-123"
            exit 1
          fi

          echo "✅ Issue detected: $ISSUE"
          echo "issue=$ISSUE" >> "$GITHUB_OUTPUT"

      # 2) Décider la cible selon la branche
      # - develop => Done (In Dev)
      # - main => Released
      # - main + hotfix => Hotfix Deployed (détecté via message de merge si possible)
      # - en manuel (workflow_dispatch): tu choisis via input "mode"
      - name: Decide target type
        id: decide
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            MODE="${{ inputs.mode }}"
          else
            MODE="${{ github.ref_name }}"   # develop ou main

            if [ "$MODE" = "main" ]; then
              MSG="${{ github.event.head_commit.message }}"
              # Si c'est un merge commit classique, il contient souvent "hotfix/"
              if echo "$MSG" | grep -qiE 'hotfix/|hotfix'; then
                MODE="hotfix"
              fi
            fi
          fi

          echo "Chosen mode: $MODE"

          # IMPORTANT: ici on met des "mots-clés" (pas des noms exacts) pour matcher FR/EN
          if [ "$MODE" = "develop" ]; then
            TARGET_KEYWORD="termin"      # match "Terminé(e)" ou "Done"
          elif [ "$MODE" = "hotfix" ]; then
            TARGET_KEYWORD="hotfix"
          else
            TARGET_KEYWORD="releas"      # match "Released"
          fi

          echo "target_keyword=$TARGET_KEYWORD" >> "$GITHUB_OUTPUT"

      # 3) Debug transitions (tu voulais savoir où l'ajouter => c'est ici)
      - name: Debug Jira transitions (TEMP)
        shell: bash
        run: |
          ISSUE="${{ steps.issue.outputs.issue }}"
          echo "=== Available transitions for $ISSUE ==="
          curl -sS -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            -H "Accept: application/json" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue/${ISSUE}/transitions" \
          | jq -r '.transitions[] | "\(.id) | \(.name) -> \(.to.name)"'

      # 4) Trouver automatiquement l'ID de transition correspondant
      - name: Resolve transition id
        id: trans
        shell: bash
        run: |
          ISSUE="${{ steps.issue.outputs.issue }}"
          KEY="${{ steps.decide.outputs.target_keyword }}"

          json=$(curl -sS -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            -H "Accept: application/json" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue/${ISSUE}/transitions")

          echo "$json" > transitions.json

          TRANS_ID=$(jq -r --arg k "$KEY" '
            .transitions[]
            | select(((.name|ascii_downcase) | contains($k)) or (((.to.name // "")|ascii_downcase) | contains($k)))
            | .id
          ' transitions.json | head -n 1)

          if [ -z "$TRANS_ID" ] || [ "$TRANS_ID" = "null" ]; then
            echo "❌ No matching transition found for keyword='$KEY'"
            echo "➡️ That means: from the CURRENT Jira status, Jira does not offer that transition."
            echo "Available transitions:"
            jq -r '.transitions[] | "\(.id) | \(.name) -> \(.to.name)"' transitions.json
            exit 1
          fi

          echo "✅ Transition id chosen: $TRANS_ID"
          echo "id=$TRANS_ID" >> "$GITHUB_OUTPUT"

      # 5) Appliquer la transition Jira (avec ID numérique)
      - name: Move Jira ticket
        uses: atlassian/gajira-transition@v3
        with:
          issue: ${{ steps.issue.outputs.issue }}
          transition: ${{ steps.trans.outputs.id }}

      # 6) Simulation déploiement
      - name: Deploy
        run: echo "Deploying artifact..."
