name: CD Transition (The Deployer)

on:
  push:
    branches:
      - develop
      - main

  # Pour tester manuellement sans merge (optionnel mais utile)
  workflow_dispatch:
    inputs:
      issue:
        description: "Jira issue key (ex: FNC-4)"
        required: true
        default: "FNC-4"
      mode:
        description: "develop | main | hotfix"
        required: true
        default: "develop"

jobs:
  cd:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to Jira
        uses: atlassian/gajira-login@v3
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

      # 1) Déterminer le ticket Jira (soit depuis workflow_dispatch, soit depuis le message du commit)
      - name: Determine Jira issue key
        id: issue
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "issue=${{ inputs.issue }}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          MSG="${{ github.event.head_commit.message }}"
          echo "Commit message: $MSG"

          ISSUE=$(echo "$MSG" | grep -oE 'FNC-[0-9]+' | head -n 1)
          if [ -z "$ISSUE" ]; then
            echo "❌ No Jira key found in commit message."
            echo "➡️ Mets FNC-4 / FNC-5 dans le titre du PR ou dans le commit."
            exit 1
          fi

          echo "issue=$ISSUE" >> "$GITHUB_OUTPUT"

      # 2) DEBUG TEMPORAIRE : afficher les transitions disponibles + leurs IDs
      - name: Debug Jira transitions (TEMP)
        shell: bash
        run: |
          ISSUE="${{ steps.issue.outputs.issue }}"
          echo "=== Transitions disponibles pour $ISSUE ==="
          curl -sS -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            -H "Accept: application/json" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue/${ISSUE}/transitions" | head -c 4000

      # 3) Choisir l'ID de transition selon develop/main/hotfix
      - name: Decide transition id
        id: decide
        shell: bash
        run: |
          # ✅ IMPORTANT :
          # Tu vas remplacer ces 3 valeurs après avoir vu les IDs dans "Debug Jira transitions (TEMP)"
          DONE_ID="6"       # Done (In Dev)
          RELEASED_ID="7"   # Released
          HOTFIX_ID="8"     # Hotfix Deployed

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            MODE="${{ inputs.mode }}"
            if [ "$MODE" = "develop" ]; then
              echo "transition_id=$DONE_ID" >> "$GITHUB_OUTPUT"
              exit 0
            fi
            if [ "$MODE" = "hotfix" ]; then
              echo "transition_id=$HOTFIX_ID" >> "$GITHUB_OUTPUT"
              exit 0
            fi
            echo "transition_id=$RELEASED_ID" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          BRANCH="${{ github.ref_name }}"
          MSG="${{ github.event.head_commit.message }}"

          # Merge vers develop => Done
          if [ "$BRANCH" = "develop" ]; then
            echo "transition_id=$DONE_ID" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Merge vers main: si le merge vient d’un hotfix => Hotfix Deployed sinon Released
          if echo "$MSG" | grep -qiE 'hotfix/|hotfix'; then
            echo "transition_id=$HOTFIX_ID" >> "$GITHUB_OUTPUT"
          else
            echo "transition_id=$RELEASED_ID" >> "$GITHUB_OUTPUT"
          fi

      # 4) Appliquer la transition Jira (avec l'ID choisi)
      - name: Move Jira ticket
        uses: atlassian/gajira-transition@v3
        with:
          issue: ${{ steps.issue.outputs.issue }}
          transition: ${{ steps.decide.outputs.transition_id }}

      # 5) Simulation du déploiement
      - name: Deploy
        run: echo "Deploying artifact..."
