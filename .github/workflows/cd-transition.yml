name: CD Transition (The Deployer)

on:
  push:
    branches:
      - develop
      - main

jobs:
  cd:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to Jira
        uses: atlassian/gajira-login@v3
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

      # 1) Extract Jira key from the merge commit message
      - name: Extract Jira issue key
        id: jirakey
        shell: bash
        run: |
          MSG="${{ github.event.head_commit.message }}"
          echo "Commit message: $MSG"

          ISSUE=$(echo "$MSG" | grep -oE 'FNC-[0-9]+' | head -n 1)

          if [ -z "$ISSUE" ]; then
            echo "❌ No Jira key found in merge commit message."
            echo "✅ Put FNC-123 in PR title (recommended)."
            exit 1
          fi

          echo "✅ Issue detected: $ISSUE"
          echo "issue=$ISSUE" >> "$GITHUB_OUTPUT"

      # 2) Decide which transition we want (by NAME)
      # (We do NOT hardcode numeric IDs, Jira language can vary, so we resolve dynamically)
      - name: Decide target transition name
        id: decide
        shell: bash
        run: |
          BRANCH="${{ github.ref_name }}"
          MSG="${{ github.event.head_commit.message }}"

          echo "Target branch: $BRANCH"
          echo "Message: $MSG"

          if [ "$BRANCH" = "develop" ]; then
            # Your Jira is in French in your screenshots -> usually "Terminé(e)"
            echo "target=Terminé(e)" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # branch = main
          # If merge commit mentions hotfix, treat as hotfix deploy
          if echo "$MSG" | grep -qiE 'hotfix/|hotfix'; then
            echo "target=Hotfix Deployed" >> "$GITHUB_OUTPUT"
          else
            echo "target=Released" >> "$GITHUB_OUTPUT"
          fi

      # 3) Resolve transition ID from Jira API safely (no YAML multi-line python)
      - name: Resolve transition id from Jira
        id: trans
        shell: bash
        run: |
          ISSUE="${{ steps.jirakey.outputs.issue }}"
          TARGET="${{ steps.decide.outputs.target }}"

          echo "Issue: $ISSUE"
          echo "Target: $TARGET"

          JSON=$(curl -sS -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            -H "Accept: application/json" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue/${ISSUE}/transitions")

          # Save JSON for debug if needed
          echo "$JSON" | head -c 2000

          # Use python one-liner WITHOUT multiline (prevents invalid YAML)
          TRANS_ID=$(python -c "import json,sys; data=json.loads(sys.stdin.read()); target='''$TARGET'''.lower(); 
for t in data.get('transitions',[]):
    name=(t.get('name') or '').lower()
    to=((t.get('to') or {}).get('name') or '').lower()
    if target in name or target in to:
        print(t.get('id',''))
        break
" <<< "$JSON")

          if [ -z "$TRANS_ID" ]; then
            echo "❌ No matching transition found for target='$TARGET'"
            echo "✅ This means Jira does NOT offer this transition from the CURRENT status."
            echo "✅ Fix: put the ticket in a status that can go to '$TARGET' (via the system steps before)."
            exit 1
          fi

          echo "✅ Transition ID = $TRANS_ID"
          echo "id=$TRANS_ID" >> "$GITHUB_OUTPUT"

      # 4) Apply Jira transition using the resolved ID
      - name: Move Jira ticket
        uses: atlassian/gajira-transition@v3
        with:
          issue: ${{ steps.jirakey.outputs.issue }}
          transition: ${{ steps.trans.outputs.id }}

      # 5) Deployment simulation
      - name: Deploy
        run: echo "Deploying artifact..."
