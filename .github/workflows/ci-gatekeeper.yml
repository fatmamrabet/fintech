name: CI Gatekeeper

on:
  pull_request:
    branches:
      - develop
      - main

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1) Vérifie qu'on a une clé Jira dans la branche ou le titre
      - name: Check Jira ticket + Extract key
        id: jirakey
        run: |
          echo "Branch: ${{ github.head_ref }}"
          echo "PR title: ${{ github.event.pull_request.title }}"

          text="${{ github.head_ref }} ${{ github.event.pull_request.title }}"

          # extrait FNC-123 (adapte si un autre projet Jira)
          issue=$(echo "$text" | grep -oE 'FNC-[0-9]+' | head -n 1)

          if [ -z "$issue" ]; then
            echo "❌ No Jira ticket found in branch name or PR title"
            exit 1
          fi

          echo "✅ Jira issue detected: $issue"
          echo "issue=$issue" >> $GITHUB_OUTPUT

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run linter
        run: flake8 .

      - name: Run tests
        run: pytest

      # 2) Login Jira
      - name: Login to Jira
        uses: atlassian/gajira-login@v3
        if: success()
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

      # 3) Lire le statut actuel pour éviter de casser si déjà Ready for Review
      - name: Get Jira status
        id: jirastatus
        if: success()
        run: |
          ISSUE="${{ steps.jirakey.outputs.issue }}"

          status=$(curl -sS -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            -H "Accept: application/json" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue/${ISSUE}?fields=status" \
            | python -c "import sys,json; print(json.load(sys.stdin)['fields']['status']['name'])")

          echo "Current Jira status: $status"
          echo "status=$status" >> $GITHUB_OUTPUT

      # 4) Debug transitions (optionnel, tu peux supprimer après)
      - name: Debug Jira transitions
        if: success()
        run: |
          ISSUE="${{ steps.jirakey.outputs.issue }}"
          echo "=== Calling Jira transitions API for $ISSUE ==="

          curl -sS --request GET \
            --url "${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue/${ISSUE}/transitions" \
            --user "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            --header "Accept: application/json" | head -c 4000

      # 5) Transition vers Ready for Review (ID=3 chez toi)
      # On le fait seulement si le ticket n'est PAS déjà "Prêt à être revu"
      - name: Move ticket to Ready for Review
        uses: atlassian/gajira-transition@v3
        if: success() && steps.jirastatus.outputs.status != 'Prêt à être revu' && steps.jirastatus.outputs.status != 'Ready for Review'
        with:
          issue: ${{ steps.jirakey.outputs.issue }}
          transition: "automatique via webhook GitHub Actions"


      # 6) Commentaire CI OK
      - name: Comment on Jira
        uses: atlassian/gajira-comment@v3
        if: success()
        with:
          issue: ${{ steps.jirakey.outputs.issue }}
          comment: "CI Passed. Ready for Peer Review."
