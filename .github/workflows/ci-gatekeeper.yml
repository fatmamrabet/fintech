name: CI Gatekeeper

# Déclenche le workflow sur toute Pull Request vers develop ou main
on:
  pull_request:
    branches:
      - develop
      - main

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Récupère le code du repo pour pouvoir tester
      - name: Checkout code
        uses: actions/checkout@v4

      # 2️⃣ Vérifie que la branche ou le titre du PR contient un ticket Jira FNC-XXX
      - name: Check Jira ticket
        run: |
          echo "Branch: ${{ github.head_ref }}"
          echo "PR title: ${{ github.event.pull_request.title }}"
          # Vérifie FNC-3 ou tout ticket FNC-[num]
          if [[ ! "${{ github.head_ref }}" =~ FNC-[0-9]+ ]] && [[ ! "${{ github.event.pull_request.title }}" =~ FNC-[0-9]+ ]]; then
            echo "❌ No Jira ticket found"
            exit 1
          fi

      # 3️⃣ Installer Python pour lint et tests
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # 4️⃣ Installer dépendances Python (pytest et flake8)
      - name: Install dependencies
        run: pip install -r requirements.txt

      # 5️⃣ Linter pour vérifier la qualité du code
      - name: Run linter
        run: flake8 .

      # 6️⃣ Exécuter les tests unitaires
      - name: Run tests
        run: pytest

      # 7️⃣ Se connecter à Jira (secrets sécurisés)
      - name: Login to Jira
        uses: atlassian/gajira-login@v3
        if: success()
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

      # 8️⃣ Déplacer automatiquement le ticket Jira vers Ready for Review si CI réussit
      - name: Move ticket to Ready for Review
        uses: atlassian/gajira-transition@v3
        if: success()
        with:
          issue: FNC-3
          transition: "Ready for Review"

      # 9️⃣ Ajouter un commentaire automatique sur le ticket Jira
      - name: Comment on Jira
        uses: atlassian/gajira-comment@v3
        if: success()
        with:
          issue: FNC-3
          comment: "CI Passed. Ready for Peer Review."
